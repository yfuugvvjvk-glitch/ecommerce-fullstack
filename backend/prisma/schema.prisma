// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  address   String?
  avatar    String?
  role      String   @default("user")
  locale    String   @default("ro")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dataItems         DataItem[]
  reviews           Review[]
  favorites         Favorite[]
  orders            Order[]
  cartItems         CartItem[]
  vouchers          Voucher[]
  userVouchers      UserVoucher[]
  voucherRequests   VoucherRequest[]
  navigationHistory NavigationHistory[]
  savedCards        SavedCard[]
  cardTransactions  CardTransaction[]
  
  // Chat system relations
  sentMessages      ChatMessage[]     @relation("MessageSender")
  chatRoomMembers   ChatRoomMember[]
  createdChatRooms  ChatRoom[]        @relation("ChatRoomCreator")

  @@index([email])
}

model SavedCard {
  id          String   @id @default(cuid())
  userId      String
  cardNumber  String   // Ultimele 4 cifre pentru afișare (DOAR carduri reale)
  cardHolder  String
  expiryMonth Int
  expiryYear  Int
  cardType    String   // VISA, MASTERCARD, etc.
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FictiveCard {
  id          String   @id @default(cuid())
  cardNumber  String   @unique
  cardHolder  String
  expiryMonth Int
  expiryYear  Int
  cvv         String
  balance     Float    @default(1000.0)
  cardType    String   @default("VISA")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions CardTransaction[]

  @@index([cardNumber])
}

model CardTransaction {
  id            String   @id @default(cuid())
  userId        String?
  fictiveCardId String?
  testCardId    String?  // Pentru carduri de test
  orderId       String?  @unique
  amount        Float
  type          String   // PAYMENT, REFUND
  status        String   @default("COMPLETED") // COMPLETED, FAILED, PENDING
  cardLast4     String?  // Ultimele 4 cifre
  cardType      String?  // VISA, MASTERCARD, etc.
  description   String?
  createdAt     DateTime @default(now())

  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  fictiveCard FictiveCard? @relation(fields: [fictiveCardId], references: [id], onDelete: SetNull)
  testCard    TestCard?    @relation(fields: [testCardId], references: [id], onDelete: SetNull)
  order       Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([fictiveCardId])
  @@index([testCardId])
  @@index([orderId])
}

model Category {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  nameRo    String?
  nameEn    String?
  icon      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  dataItems DataItem[]

  @@index([slug])
}

model DataItem {
  id              String   @id @default(cuid())
  title           String
  description     String?
  content         String   @db.Text
  price           Float
  oldPrice        Float?
  stock           Int      @default(0)
  lowStockAlert   Int      @default(5)
  isInStock       Boolean  @default(true)
  trackInventory  Boolean  @default(true)
  image           String
  categoryId      String
  status          String   @default("draft")
  rating          Float    @default(0)
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  category          Category            @relation(fields: [categoryId], references: [id])
  reviews           Review[]
  favorites         Favorite[]
  orderItems        OrderItem[]
  cartItems         CartItem[]
  productOffers     ProductOffer[]
  navigationHistory NavigationHistory[]

  @@index([userId])
  @@index([status])
  @@index([categoryId])
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String   @db.Text
  userId     String
  dataItemId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)

  @@unique([userId, dataItemId])
  @@index([dataItemId])
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  dataItemId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)

  @@unique([userId, dataItemId])
  @@index([userId])
}

model Order {
  id              String   @id @default(cuid())
  userId          String
  total           Float
  subtotal        Float?
  tax             Float    @default(0)
  discount        Float    @default(0)
  shippingCost    Float    @default(0)
  status          String   @default("PROCESSING")
  shippingAddress String   @db.Text
  deliveryPhone   String?
  deliveryName    String?
  paymentMethod   String   @default("cash")
  deliveryMethod  String   @default("courier")
  invoiceNumber   String?  @unique
  invoiceGenerated Boolean @default(false)
  orderLocalTime  String?  // Timpul local când a fost plasată comanda
  orderLocation   String?  // Locația de unde a fost plasată comanda (oraș, țară)
  orderTimezone   String?  // Timezone-ul local
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]
  voucherUsed     UserVoucher?
  cardTransaction CardTransaction?

  @@index([userId])
  @@index([status])
  @@index([invoiceNumber])
}

model OrderItem {
  id         String @id @default(cuid())
  orderId    String
  dataItemId String
  quantity   Int
  price      Float

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model CartItem {
  id         String   @id @default(cuid())
  userId     String
  dataItemId String
  quantity   Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)

  @@unique([userId, dataItemId])
  @@index([userId])
}

model Voucher {
  id            String    @id @default(cuid())
  code          String    @unique
  description   String?
  discountType  String    @default("PERCENTAGE") // "PERCENTAGE" or "FIXED"
  discountValue Float
  minPurchase   Float?
  maxDiscount   Float?
  maxUsage      Int?
  usedCount     Int       @default(0)
  validFrom     DateTime  @default(now())
  validUntil    DateTime?
  isActive      Boolean   @default(true)
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  createdBy    User          @relation(fields: [createdById], references: [id], onDelete: Cascade)
  userVouchers UserVoucher[]

  @@index([code])
  @@index([isActive])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String
  eventType String
  eventData Json
  timestamp DateTime @default(now())
  userAgent String
  ipAddress String

  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model UserVoucher {
  id         String    @id @default(cuid())
  userId     String
  voucherId  String
  usedAt     DateTime?
  orderId    String?   @unique
  createdAt  DateTime  @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucher Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  order   Order?   @relation(fields: [orderId], references: [id])

  @@unique([userId, voucherId])
  @@index([userId])
  @@index([voucherId])
}

model VoucherRequest {
  id            String    @id @default(cuid())
  userId        String
  code          String    @default("REQUESTED")
  discountType  String    @default("PERCENTAGE") // "PERCENTAGE" or "FIXED"
  discountValue Float     @default(10)
  minPurchase   Float?
  validUntil    DateTime?
  description   String    @db.Text
  status        String    @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Offer {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  image       String
  discount    Float    // Percentage
  validFrom   DateTime @default(now())
  validUntil  DateTime
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products ProductOffer[]

  @@index([active])
  @@index([validFrom])
  @@index([validUntil])
}

model ProductOffer {
  id         String   @id @default(cuid())
  dataItemId String
  offerId    String
  createdAt  DateTime @default(now())

  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)
  offer    Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@unique([dataItemId, offerId])
  @@index([dataItemId])
  @@index([offerId])
}

model NavigationHistory {
  id         String   @id @default(cuid())
  userId     String
  dataItemId String
  viewedAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataItem DataItem @relation(fields: [dataItemId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@index([dataItemId])
}

// Carduri de test create de admin pentru simulare (DOAR PENTRU ADMIN)
model TestCard {
  id          String   @id @default(cuid())
  cardNumber  String   @unique // Numărul complet al cardului de test
  cardHolder  String
  expiryMonth Int
  expiryYear  Int
  cvv         String
  cardType    String   // VISA, MASTERCARD, AMEX
  balance     Float    @default(1000) // Balanța simulată
  isActive    Boolean  @default(true)
  createdBy   String   // ID-ul adminului care l-a creat
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions CardTransaction[]

  @@index([cardNumber])
  @@index([isActive])
}

// Chat System Models
model ChatRoom {
  id          String   @id @default(cuid())
  name        String?  // Numele grupului (null pentru chat direct)
  description String?
  type        String   @default("DIRECT") // "DIRECT", "GROUP", "SUPPORT"
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User             @relation("ChatRoomCreator", fields: [createdById], references: [id], onDelete: Cascade)
  members   ChatRoomMember[]
  messages  ChatMessage[]

  @@index([type])
  @@index([isActive])
  @@index([createdById])
}

model ChatRoomMember {
  id         String    @id @default(cuid())
  chatRoomId String
  userId     String
  role       String    @default("MEMBER") // "MEMBER", "ADMIN", "MODERATOR"
  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  isActive   Boolean   @default(true)

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatRoomId, userId])
  @@index([chatRoomId])
  @@index([userId])
  @@index([isActive])
}

model ChatMessage {
  id         String    @id @default(cuid())
  chatRoomId String
  senderId   String
  content    String    @db.Text
  type       String    @default("TEXT") // "TEXT", "IMAGE", "FILE", "SYSTEM"
  fileUrl    String?   // Pentru imagini/fișiere
  fileName   String?   // Numele original al fișierului
  isEdited   Boolean   @default(false)
  editedAt   DateTime?
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  readBy   ChatMessageRead[]

  @@index([chatRoomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isDeleted])
}

model ChatMessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}
